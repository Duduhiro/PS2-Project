    <!DOCTYPE html>

    <html>

    <head>
        <title>MackDorms - Reservas</title>
        <meta charset="UTF-8">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">    </head>
		<link href="./styles/index.css" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
		<style>
			input[type=number]::-webkit-inner-spin-button,
			input[type=number]::-webkit-outer-spin-button {
				-webkit-appearance: none;
				margin: 0;
			}
			input[type=number] {
				-moz-appearance: textfield;
			}
		</style>
	</head>
    
    <body>

        <header class="p-2 ps-3 container-fluid d-flex align-items-center bg-light" style="gap: 20px; width: 100%" >
			<h1><a href="./index.html" class="text-reset text-decoration-none">Hotel MackDorms</a></h1>
			<a href="hospedes.html" class="fs-3 text-secondary text-decoration-none ">Hóspedes</a>
			<a href="reservas.html" class="fs-3 text-secondary text-decoration-none ">Reservas</a>
		</header>


		<div class="container-fluid d-flex flex-column align-items-center">
			<h1>Gerenciamento de reservas</h1>

			<form class="container-sm w-50 row mb-4 g-3 needs-validation" novalidate>
				<div class="col-md-2">
					<label for="txtId" class="form-label">ID</label>
					<input type="text" class="form-control" id="txtId" required>
				</div>
				<div class="col-md-10">
					<label for="txtCheckIn" class="form-label">CheckIn</label>
					<input type="date" class="form-control" id="txtCheckIn" required>
					<div class="invalid-feedback">
						Insira a data de check-in.
					</div>
				</div>
				<div class="col-md-12">
					<label for="txtCheckOut" class="form-label">CheckOut</label>
					<input type="date" class="form-control" id="txtCheckOut" required>
					<div class="invalid-feedback">
						Insira a data de check-out.
					</div>
				</div>
				<div class="col-md-8">
					<label for="txtValor" class="form-label">Valor</label>
					<input type="number" class="form-control" id="txtValor" min="1" placeholder="$" required>
					<div class="invalid-feedback">
						Insira um valor válido.
					</div>
				</div>
				<div class="col-md-4">
					<label for="txtHospede" class="form-label">Hóspede</label>
					<select class="form-select" id="txtHospede" required aria-label="Default select example">
						<option selected value="-1"></option>
					</select>
					<div class="invalid-feedback">
						Escolha um hóspede.
					</div>
				</div>
				<div class="col-md-12 mt-4 text-center">
					<input type="button" class="btn btn-primary" value="Novo" onclick="novaReserva()" id="btnNovo">
					<input type="button" class="btn btn-success" value="Salvar" onclick="salvarReserva()" id="btnSalvar">
					<input type="button" class="btn btn-danger" value="Apagar" onclick="apagarReserva()" id="btnApagar">
					<input type="button" class="btn btn-warning" value="Cancelar" onclick="cancelarEdicao()" id="btnCancelar">
				</div>
			</form> 
			
			<p style="font-weight:bold" id="paragrafoMensagem"></p>
			
			<table class="table w-50 table-striped mt-2">    
				<tr class="table-secondary"> 
					<th>ID</th> 
					<th>Check-in</th> 
					<th>Check-out</th>
					<th>Valor</th>
					<th>Hóspede</th>
				</tr>
				<tbody id="corpoTabelaReservas"></tbody>
			</table>
		</div>
        
	    <script>
	        const corpoTabela = document.querySelector('#corpoTabelaReservas');
	        const paragrafoMensagem = document.querySelector('#paragrafoMensagem');
	        const txtCheckIn = document.querySelector('#txtCheckIn');
	        const txtCheckOut = document.querySelector('#txtCheckOut');
	        const txtValor = document.querySelector('#txtValor');
			const txtHospede = document.querySelector('#txtHospede');
	        const txtId = document.querySelector('#txtId');
	        
			var hospedes;

	        const btnNovo = document.querySelector('#btnNovo');
	        const btnSalvar = document.querySelector('#btnSalvar');
	        const btnApagar = document.querySelector('#btnApagar');
	        const btnCancelar = document.querySelector('#btnCancelar');
	        var criandoNovaReserva = false;
	        
	        inicializar();

	        function inicializar() {
	        	criandoNovaReserva = false;
	            paragrafoMensagem.innerHTML = 'Pressione o botão Novo ou selecione uma reserva da lista:'
	            txtId.value = '';
	            txtCheckIn.value = '';
				txtCheckOut.value = '';
				txtValor.value = null;
				txtHospede.value = '';

				while (txtHospede.lastChild.value != -1) {
					txtHospede.removeChild(txtHospede.lastChild);
				}

	            txtId.disabled = true;
	            txtCheckIn.disabled = true;
				txtCheckOut.disabled = true;
				txtValor.disabled = true;
				txtHospede.disabled = true;

	            btnNovo.disabled = false;
	            btnSalvar.disabled = true;
	            btnApagar.disabled = true;
	            btnCancelar.disabled = true;
				listarTodosHospedes();
	            listarTodasReservas();            
	        }

			function validarForm() {
				var form = document.querySelector('form');
				if (form.checkValidity()) {
					return true;
				} else {
					form.classList.add('was-validated');
					return false;
				}
			}

			async function listarTodosHospedes() {
	            const URL = `/api/hospedes`;
	            fetch(URL)
	              .then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta;}) 
	              .then(resposta => resposta.json())
	              .then(data => {
					data.forEach(element => {
						const option = document.createElement('option');
						option.value = element.id + ' - ' +  element.nome;
						option.textContent = element.id + ' - ' +  element.nome;
						txtHospede.appendChild(option);
					});
				  })
	              .catch(function(error) { paragrafoMensagem.innerHTML = "Erro ao listar hóspedes (código " + error.message + ")";});
	        }

	        async function listarTodasReservas() {
	            const URL = `/api/reservas`;
	            fetch(URL)
	              .then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta;}) 
	              .then(resposta => resposta.json())
	              .then(jsonResponse => preencherTabela(jsonResponse))
	              .catch(function(error) { paragrafoMensagem.innerHTML = "Erro ao listar reservas (código " + error.message + ")";});
	        }
	        
	        
	        function preencherTabela(reservas) {
	            var linhasTabela = '';
	            var n = reservas.length;
	            for (var i = 0; i < n; i++) {
	                var f = reservas[i];
	                linhasTabela += 
	                	`<tr><td><a href="javascript:void(0)" onclick="selecionarReserva('${f.id}','${f.dataCheckIn}','${f.dataCheckOut}','${f.valorReserva}','${f.id_hospede}')">` 
	                    + f.id     + '</a></td>' + 
	                    '<td>' + f.dataCheckIn + '</td>' +
	                    '<td>' + f.dataCheckOut + '</td>' +
	                    '<td>R$ ' + f.valorReserva + ',00</td>' +
	                    '<td><a href="./hospedes.html">' + f.id_hospede + '</a></td> </tr>\n';
	            }
	            corpoTabela.innerHTML = linhasTabela;
	        }

	        function selecionarReserva(id, checkIn, checkOut, valor, hospede) {
	        	criandoNovaReserva = false;
	            paragrafoMensagem.innerHTML = 'Altere e salve os dados da reserva, ou então apague o registro da reserva.'
	            txtId.value = id;
	            txtCheckIn.value = checkIn;
				txtCheckOut.value = checkOut;
				txtValor.value = valor;
				txtHospede.value = hospede;

	            txtId.disabled = true;
	            txtCheckIn.disabled = false;
				txtCheckOut.disabled = false;
				txtValor.disabled = false;
				txtHospede.disabled = false;

	            btnNovo.disabled = true;
	            btnSalvar.disabled = false;
	            btnApagar.disabled = false;
	            btnCancelar.disabled = false;  
	        }

	        function novaReserva() {
	        	paragrafoMensagem.innerHTML = 'Preencha os dados da nova reserva...';
	        	criandoNovaReserva = true;
	        	
	        	txtId.value = '';
	        	txtCheckIn.value = '';
				txtCheckOut.value = '';
				txtValor.value = null;
				txtHospede.value = '';
	        	
	        	txtId.disabled = true;
	        	txtCheckIn.disabled = false;
				txtCheckOut.disabled = false;
				txtValor.disabled = false;
				txtHospede.disabled = false;
	        	
	        	btnNovo.disabled = true;
	        	btnSalvar.disabled = false;
	        	btnApagar.disabled = true;
	        	btnCancelar.disabled = false;
	        }
	        
	        function salvarReserva() {

				if(!validarForm()) {
					return;
				}

	        	if (criandoNovaReserva) {
	        		criarReserva();
	        	}
	        	else {
	        		alterarReserva();
	        	}
	        }
	        
	        async function criarReserva() {
	        	const URL = `/api/reservas`;

				let parts = txtCheckIn.value.split('-');
				let cInDate = parts[2] + '-' + parts[1] + '-' + parts[0];

				parts = txtCheckOut.value.split('-');
				let cOutDate = parts[2] + '-' + parts[1] + '-' + parts[0];

	        	const dadosReserva = {
	        		'dataCheckIn': cInDate,
					'dataCheckOut': cOutDate,
					'valorReserva': txtValor.value,
					'id_hospede': txtHospede.value
	        	};
	        	const postRequest = {
	        		method: 'POST',
	        		body: JSON.stringify(dadosReserva),
	        		headers: { 'Content-type': 'application/json' }
	        	};
	        	fetch(URL, postRequest)
	        		.then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta; } )
	        		.then(resposta => resposta.json())
	        		.then(jsonResponse => inicializar())
	        		.catch(function(error) { paragrafoMensagem.innerHTML = 'Erro ao criar nova reserva (código ' + error.message + ')'; } );
	        }
	        
	        async function alterarReserva() {
	        	const ID = txtId.value;
	        	const URL = `/api/reservas/${ID}`;

				let parts = txtCheckIn.value.split('-');
				let cInDate = parts[2] + '-' + parts[1] + '-' + parts[0];

				parts = txtCheckOut.value.split('-');
				let cOutDate = parts[2] + '-' + parts[1] + '-' + parts[0];

	        	const dadosReserva = {
	        		'id': ID,
	        		'dataCheckIn': cInDate,
					'dataCheckOut': cOutDate,
					'valorReserva': txtValor.value,
					'id_hospede': txtHospede.value
	        	};
	        	const putRequest = {
	        		method: 'PUT',
	        		body: JSON.stringify(dadosReserva),
	        		headers: { 'Content-type': 'application/json' }
	        	};
	        	fetch(URL, putRequest)
	        		.then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta; } )
	        		.then(resposta => resposta.json())
	        		.then(jsonResponse => inicializar())
	        		.catch(function(error) { paragrafoMensagem.innerHTML = 'Erro ao alterar reserva (código ' + error.message + ')'; } );	        	
	        }
	        
	        function cancelarEdicao() {
	        	inicializar();
	        }
	        
	        async function apagarReserva() {
	        	const ID = txtId.value;
	        	const URL = `/api/reservas/${ID}`;
	        	const deleteRequest = {
	        		method: 'DELETE'
	        	};
	        	fetch(URL, deleteRequest)
	        		.then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta; } )
	        		.then(resposta => inicializar())
	        		.catch(function(error) { paragrafoMensagem.innerHTML = 'Erro ao apagar reserva (código ' + error.message + ')'; } );	        		
	        }
	        
	    </script>    
    </body>
    
    </html>

    